<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Airkm Live Power</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <style>
    :root{--bg:#0f0f1b;--card:#ffffff08;--accent:#00e5ff}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Poppins',sans-serif;background:linear-gradient(135deg,var(--bg) 0%,#1a1a2e 100%);color:#fff;min-height:100vh;display:flex;align-items:center;justify-content:center}
    .card{background:var(--card);border:1px solid #ffffff20;border-radius:22px;padding:35px;max-width:720px;backdrop-filter:blur(20px);box-shadow:0 8px 32px rgba(0,229,255,.25)}
    .metrics{display:flex;gap:40px;margin-bottom:25px;text-align:center}
    .metric span{font-size:26px;font-weight:600;color:var(--accent)}
    .metric div{font-size:14px;color:#aaa}
    .switch-cont{display:flex;align-items:center;gap:15px;margin-bottom:25px;font-size:18px}
    .switch{position:relative;width:60px;height:30px}
    .switch input{opacity:0;width:0;height:0}
    .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#444;border-radius:34px;transition:.4s}
    .slider:before{position:absolute;content:"";height:22px;width:22px;left:4px;bottom:4px;background:#fff;border-radius:50%;transition:.4s}
    input:checked + .slider{background:var(--accent)}
    input:checked + .slider:before{transform:translateX(30px)}
    canvas{max-width:100%;height:240px;border-radius:10px;background:#111}
    .controls{display:flex;justify-content:space-between;margin-top:20px;flex-wrap:wrap;gap:10px}
    .controls button{background:var(--accent);color:#000;padding:8px 14px;border:none;border-radius:10px;font-weight:600;cursor:pointer}
    .controls select{background:#222;color:#fff;padding:8px 12px;border-radius:10px;border:1px solid #555}
  </style>
</head>
<body>
<div class="card">
  <h2>Airkm Live Power Dashboard</h2>

  <!-- Metrics -->
  <div class="metrics">
    <div class="metric"><span id="voltage">—</span><div>Voltage (V)</div></div>
    <div class="metric"><span id="current">—</span><div>Current (A)</div></div>
    <div class="metric"><span id="power">—</span><div>Power (W)</div></div>
  </div>

  <!-- Switch -->
  <div class="switch-cont">
    <label>ON / OFF</label>
    <label class="switch">
      <input type="checkbox" id="sw" onchange="toggle(this.checked)">
      <span class="slider"></span>
    </label>
  </div>

  <!-- Controls -->
  <div class="controls">
    <select id="mode" onchange="changeMode(this.value)">
      <option value="live">Live (Per Second)</option>
      <option value="hourly">Hourly Average</option>
    </select>
    <button onclick="manualSave()">Save Current</button>
    <button onclick="window.location='/download'">Download CSV</button>
  </div>

  <!-- Chart -->
  <canvas id="chart"></canvas>
</div>

<script>
const chart = new Chart(document.getElementById('chart'), {
  type:'line',
  data:{datasets:[{
    label:'Power (W)',
    data:[],
    borderColor:'#0ff',
    backgroundColor:'rgba(0,255,255,.1)',
    fill:true,
    tension:.3
  }]},
  options:{
    responsive:true,
    scales:{
      x:{
        type:'time',
        time:{
          unit:'hour',
          tooltipFormat: 'PPpp',
          displayFormats: {
            hour: 'HH:mm'
          }
        },
        ticks: {
          source: 'auto',
          maxRotation: 0,
          autoSkip: true,
          maxTicksLimit: 24  // max 24 ticks = 1 tick per hour for 24h
        }
      },
      y:{beginAtZero:true}
    },
    plugins:{legend:{display:false}}
  }
});

let mode = 'live';
let liveInterval = null;

async function fetchLive(){
  try {
    const r = await fetch('/api/live');
    const j = await r.json();

    // Update metrics
    document.getElementById('voltage').textContent = j.voltage.toFixed(1);
    document.getElementById('current').textContent = j.current.toFixed(2);
    document.getElementById('power').textContent   = j.power.toFixed(1);
    document.getElementById('sw').checked          = j.switch;

    // Update chart with last 24h per-second data
    chart.data.datasets[0].data = j.history.map(d => ({
      x: d.x,
      y: d.y
    }));

    // Enforce hourly ticks on x-axis
    chart.options.scales.x.time.unit = 'hour';

    chart.update();
  } catch (e) {
    console.error('Error fetching live data:', e);
  }
}

async function fetchHourly(){
  const r = await fetch('/api/hourly');
  const j = await r.json();
  chart.data.datasets[0].data = j.map(row => ({
    x: new Date(row.hour),
    y: row.avg_power
  }));
  chart.options.scales.x.time.unit = 'hour';
  chart.update();
}

function changeMode(val){
  mode = val;
  clearInterval(liveInterval);
  if(mode === 'live'){
    fetchLive();
    liveInterval = setInterval(fetchLive, 1000);
  } else {
    fetchHourly();
  }
}

async function toggle(on){
  await fetch('/switch', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({on})
  });
}

async function manualSave(){
  const voltage = parseFloat(document.getElementById('voltage').textContent);
  const current = parseFloat(document.getElementById('current').textContent);
  const power   = parseFloat(document.getElementById('power').textContent);
  if(!isNaN(voltage) && !isNaN(current) && !isNaN(power)){
    await fetch('/save',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({voltage, current, power})
    });
    alert('Saved!');
  }
}

// Start in live mode
changeMode('live');
</script>
</body>
</html>
